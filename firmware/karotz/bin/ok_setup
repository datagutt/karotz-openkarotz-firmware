#!/bin/bash

function ReadUrlParam {  
 saveIFS=$IFS
  IFS='=&'
  parm=($QUERY_STRING)
  IFS=$saveIFS
  for ((i=0; i<${#parm[@]}; i+=2))
  do
      URLParam[${parm[i]}]=${parm[i+1]}
  done
}

TDIR="/usr/www"
UDIR="/mnt/usbkey"
SURL="http://www.filippi.org/OpenKarotz"

ReadUrlParam

echo "Server: OpenKarotz WebServer 1.0 - Massalia 2013"
echo "Connection: close"
echo "Accept-Ranges: bytes"
echo "Content-type: text/plain"
echo ""

# Checking Forced Update
FU=${URLParam[force]}
UU=${URLParam[usb]}
if [ "$FU" == "1" ]; then
 rm -f $TDIR/ok.version >>/dev/null 2>>/dev/null
fi

# Checking root Web
if [ ! -d "$TDIR" ]; then
   mkdir $TDIR >>/dev/null 2>>/dev/null
fi

# Checking cgi-bin
if [ ! -d "$TDIR"/cgi-bin ]; then
   mkdir $TDIR/cgi-bin >>/dev/null 2>>/dev/null
fi   

# Checking images
if [ ! -d "$TDIR"/images ]; then
   mkdir $TDIR/images >>/dev/null 2>>/dev/null
fi

# Checking Sym link
#ln -s /www /usr/www >>/dev/null 2>>/dev/null
#chmod 777 /www >>/dev/null 2>>/dev/null

# Get local version
if [ ! -f $TDIR/ok.version ]; then
   LV=0
else
   LV=$(cat $TDIR/ok.version  )
fi

# Get server Version
rm $TDIR/server.ok.version >>/dev/null 2>>/dev/null
echo "----------------------------------------"
wget $SURL/ok.version -q -O $TDIR/server.ok.version 
RV=$(cat $TDIR/server.ok.version )

# Display version
echo -n "Server Version : "
echo $RV
echo -n "Local Version  : "
echo $LV


if [ "${LV:-0}" -ge "${RV:-0}" ] ; then
	echo "----------------------------------------"
  	echo "No update needed"
else
    # Update local version
    rm -f $TDIR/ok.version >>/dev/null 2>>/dev/null
    mv $TDIR/server.ok.version $TDIR/ok.version >>/dev/null 2>>/dev/null
        
    echo "----------------------------------------"
    echo "Updating /www"
    echo "----------------------------------------"
    
    wget $SURL/www/list.txt -O $TDIR/list.txt -q > /dev/null
    while read line;
    do
    echo "$line"
    wget $SURL/www/$line -q -O $TDIR/$line> /dev/null
    chmod 777 $TDIR/$line
    done < $TDIR/list.txt
    
    echo "----------------------------------------"
    echo "Updating /www/cgi-bin"
    echo "----------------------------------------"
    rm $TDIR/list.txt> /dev/null
    wget $SURL/www/cgi-bin/list.txt -q -O $TDIR/list.txt> /dev/null
    while read line;
    do
    echo "$line"
    wget $SURL/www/cgi-bin/$line -q -O $TDIR/cgi-bin/$line> /dev/null
    chmod 777 $TDIR/cgi-bin/$line
    done < $TDIR/list.txt
    
    echo "----------------------------------------"
    echo "Updating /www/images"
    echo "----------------------------------------"
    rm $TDIR/list.txt> /dev/null
    wget $SURL/www/images/list.txt -q -O $TDIR/list.txt> /dev/null
    while read line;
    do
    echo "$line"    
    wget $SURL/www/images/$line -q -O $TDIR/images/$line> /dev/null
    chmod 777 $TDIR/images/$line
    done < $TDIR/list.txt
    rm $TDIR/list.txt> /dev/null
 
	if [ "$UU" == "1" ]; then 
        echo "----------------------------------------"
        echo "Checking USB Key structure"
        echo "----------------------------------------"
        if [ ! -d "$UDIR/Firmwares" ]; then
           mkdir $UDIR/Firmwares >>/dev/null 2>>/dev/null
           echo -n "."
        else
           echo -n "o"
        fi
    
        if [ ! -d "$UDIR/Histoires" ]; then
           mkdir $UDIR/Histoires >>/dev/null 2>>/dev/null
               echo -n "."
        else
           echo -n "o"
        fi
    
        echo -n "."
        if [ ! -d "$UDIR/Moods" ]; then
           mkdir $UDIR/Moods >>/dev/null 2>>/dev/null
               echo -n "."
        else
           echo -n "o"
        fi
    
        echo -n "."
        if [ ! -d "$UDIR/Moods/fr" ]; then
           mkdir $UDIR/Moods/fr >>/dev/null 2>>/dev/null
               echo -n "."
        else
           echo -n "o"
        fi
    
        echo -n "."
        if [ ! -d "$UDIR/Run" ]; then
           mkdir $UDIR/Run >>/dev/null 2>>/dev/null
               echo -n "."
        else
           echo -n "o"
        fi
    
        echo -n "."
        if [ ! -d "$UDIR/Rfid" ]; then
        i   mkdir $UDIR/Rfid >>/dev/null 2>>/dev/null
               echo -n "."
        else
           echo -n "o"
        fi
    
        echo -n "."
        if [ ! -d "$UDIR/Sounds" ]; then
           mkdir $UDIR/Sounds >>/dev/null 2>>/dev/null
               echo -n "."
        else
           echo -n "o"
        fi
    
        echo -n "."
        if [ ! -d "$UDIR/Tmp" ]; then
           mkdir $UDIR/Tmp >>/dev/null 2>>/dev/null
               echo -n "."
        else
           echo -n "o"
        fi
    
        echo -n "."
        if [ ! -d "$UDIR/Voice" ]; then
           mkdir $UDIR/Voice >>/dev/null 2>>/dev/null
           echo -n "."
        else
           echo -n "o"
        fi
    
        echo -n "."
        if [ ! -d "$UDIR/Rfid" ]; then
           mkdir $UDIR/Rfid >>/dev/null 2>>/dev/null
               echo -n "."
        else
           echo -n "o"
        fi
    
        echo -n ""
        echo "----------------------------------------"
        echo "Updating Voices"
        echo "----------------------------------------"
        wget $SURL/usbkey/Voice/list.txt -q -O $UDIR/list.txt> /dev/null
        while read line;
        do
        echo "$line"
        wget $SURL/usbkey/voice/$line -q -O $UDIR/Voice/$line> /dev/null
        chmod 777 $UDIR/Voice/$line
        done < $UDIR/list.txt
        
        echo "----------------------------------------"
        echo "Updating Sounds"
        echo "----------------------------------------"
        wget $SURL/usbkey/Sounds/list.txt -q -O $UDIR/list.txt> /dev/null
        while read line;
        do
        echo "$line"
        wget $SURL/usbkey/Sounds/$line -q -O $UDIR/Sounds/$line> /dev/null
        chmod 777 $UDIR/Sounds/$line
        done < $UDIR/list.txt
        rm $UDIR/list.txt> /dev/null
    
        echo "----------------------------------------"
        echo "Updating Firmware Files"
        echo "----------------------------------------"
        wget $SURL/usbkey/Firmwares/list.txt -q -O $UDIR/list.txt> /dev/null
        while read line;
        do
        echo "$line"
        wget $SURL/usbkey/Firmwares/$line -q -O $UDIR/Firmwares/$line> /dev/null
        chmod 555 $UDIR/Firmwares/$line
        done < $UDIR/list.txt
        rm $UDIR/list.txt> /dev/null
        
        echo "----------------------------------------"
        echo "Updating Stories (fr)"
        echo "----------------------------------------"
        wget $SURL/usbkey/Histoires/list.txt -q -O $UDIR/list.txt> /dev/null
        while read line;
        do
        echo "$line"
        wget $SURL/usbkey/Histoires/$line -q -O $UDIR/Histoires/$line> /dev/null
        chmod 777 $UDIR/Histoires/$line
        done < $UDIR/list.txt
        rm $UDIR/list.txt> /dev/null
        
        echo "----------------------------------------"
        echo "Updating Moods (fr)"
        echo "----------------------------------------"
        for ((i = 1; i < 400; i += 1))
        do
        echo "$i".mp3
        wget $SURL/usbkey/Moods/fr/$i.mp3 -q -O $UDIR/Moods/fr/$i.mp3 > /dev/null
        chmod 777 $UDIR/Moods/fr/$i.mp3         
        done
    fi
fi
echo "----------------------------------------"
echo done

